package persistence

import (
    "context"
    "database/sql"
    "errors"

    "github.com/jmoiron/sqlx"
)

func runInTx(ctx context.Context, db *sqlx.DB, fn func(tx *sqlx.Tx) error) error {
    tx, err := db.BeginTxx(ctx, &sql.TxOptions{Isolation: sql.LevelDefault})
    if err != nil {
        return err
    }
    err = fn(tx)
    if err == nil {
        return tx.Commit()
    }
    if rbErr := tx.Rollback(); rbErr != nil {
        return errors.Join(err, rbErr)
    }
    return err
}
