package http

import (
    "fmt"
    "net/http"
    "path/filepath"

    "github.com/go-chi/chi/v5"
{{- if .Stack.HasFeature "frontend-htmx" }}
    "sync/atomic"
{{- end }}
{{- if .Stack.HasFeature "auth-github-oauth2" }}
    appauth "{{ .ModulePath }}/internal/app/auth"
    {{- end }}
)

var indexPage = filepath.Join("web", "templates", "pages", "index.html")

type Router struct {
{{- if .Stack.HasFeature "frontend-htmx" }}
    exampleCounter atomic.Int64
{{- end }}
{{- if .Stack.HasFeature "auth-github-oauth2" }}
    authService *appauth.Service
{{- end }}
}

// NewRouter prepares chi routes for the generated project.
func NewRouter() *Router {
    return &Router{}
}

// Mount binds routes onto the provided chi router instance.
func (r *Router) Mount(router chi.Router) {
    router.Get("/", r.home)
    router.Get("/healthz", r.health)
    router.Post("/demo/echo", r.demoEcho)

    {{- if .Stack.HasFeature "auth-github-oauth2" }}
    // Auth routes
    router.Get("/auth/{provider}", r.authStart)
    router.Get("/auth/{provider}/callback", r.authCallback)
    router.Get("/logout", r.logout)
    router.Get("/login", r.login)
    router.With(r.RequireAuth).Get("/profile", r.profile)
    {{- end }}

{{- if .Stack.HasFeature "frontend-htmx" }}
    // Demo API routes backing the generated UI examples. Remove them once replaced.
    router.Get("/api/counter", r.apiCounter)
    router.Post("/api/increment", r.apiIncrement)
    router.Get("/api/todos", r.apiTodos)
    {{- if and (.Stack.HasFeature "frontend-htmx") (or (has "Basecoat" .Stack.Tags) (has "DaisyUI" .Stack.Tags)) }}
    router.Get("/fragments/toast/success", r.toastSuccess)
    {{- end }}
{{- end }}
}

{{- if .Stack.HasFeature "auth-github-oauth2" }}

// SetAuthService injects the authentication service into the router.
func (r *Router) SetAuthService(svc *appauth.Service) {
    r.authService = svc
}

{{- end }}

func (r *Router) home(w http.ResponseWriter, req *http.Request) {
{{- if .Stack.HasFeature "auth-github-oauth2" }}
    if err := renderPage(w, req, indexPage, nil); err != nil {
        http.Error(w, fmt.Sprintf("render error: %v", err), http.StatusInternalServerError)
        return
    }
{{- else }}
    http.ServeFile(w, req, indexPage)
{{- end }}
}

func (r *Router) health(w http.ResponseWriter, req *http.Request) {
    w.Header().Set("Content-Type", "text/plain; charset=utf-8")
    _, _ = w.Write([]byte("ok"))
}

// demoEcho handles a sample POST request and echos a value back.
func (r *Router) demoEcho(w http.ResponseWriter, req *http.Request) {
    if req.Method != http.MethodPost {
        http.Error(w, "Method not allowed", http.StatusMethodNotAllowed)
        return
    }
    if err := req.ParseForm(); err != nil {
        http.Error(w, "Bad request", http.StatusBadRequest)
        return
    }
    msg := req.Form.Get("message")
    if msg == "" {
        msg = "(empty)"
    }
    w.Header().Set("Content-Type", "text/plain; charset=utf-8")
    _, _ = w.Write([]byte(msg))
}

{{- if .Stack.HasFeature "frontend-htmx" }}

func (r *Router) apiCounter(w http.ResponseWriter, req *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    count := r.exampleCounter.Load()

{{- if has "DaisyUI" .Stack.Tags }}
    fmt.Fprintf(w, `<div class="card bg-base-100 shadow-xl">
    <div class="card-body gap-4">
        <header class="flex items-start justify-between gap-3">
            <section>
                <h3 class="card-title text-lg">Server counter</h3>
                <p class="text-sm opacity-70">Rendered via HTMX.</p>
            </section>
            <span class="badge badge-outline badge-primary uppercase tracking-[0.2em]">HTMX</span>
        </header>
        <section class="space-y-1">
            <p class="text-sm opacity-70">Current value</p>
            <span id="count" class="text-3xl font-black">%d</span>
        </section>
        <div class="card-actions justify-end">
            <button class="btn btn-primary" hx-post="/api/increment" hx-target="#count" hx-swap="innerHTML">Increment</button>
        </div>
    </div>
</div>`, count)
{{- else }}
    fmt.Fprintf(w, `<div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4">
    <header class="space-y-1">
        <h3 class="text-base font-semibold text-slate-900">Server counter</h3>
        <p class="text-sm text-slate-600">Rendered via HTMX.</p>
    </header>
    <div>
        <p class="text-sm text-slate-600">Current value</p>
        <span id="count" class="text-3xl font-semibold text-slate-900">%d</span>
    </div>
    <button class="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-4 py-2 text-white font-medium hover:bg-sky-700 transition" hx-post="/api/increment" hx-target="#count" hx-swap="innerHTML">
        Increment
    </button>
</div>`, count)
{{- end }}
}

func (r *Router) apiIncrement(w http.ResponseWriter, req *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    count := r.exampleCounter.Add(1)
    fmt.Fprintf(w, "%d", count)
}

func (r *Router) apiTodos(w http.ResponseWriter, req *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    todos := []struct {
        Title string
        Done  bool
    }{
        {"Learn HTMX basics", true},
        {"Build server-side components", true},
        {"Create interactive UI without JavaScript", false},
        {"Deploy your app", false},
    }

{{- if has "DaisyUI" .Stack.Tags }}
    html := `<div class="card bg-base-100 shadow-xl"><div class="card-body gap-4"><header class="space-y-1"><h3 class="card-title text-lg">Todo list</h3><p class="text-sm opacity-70">Loaded from the server using HTMX.</p></header><ul class="space-y-2 text-sm">`
    for _, todo := range todos {
        statusLabel := "Pending"
        badgeClass := "badge badge-outline"
        if todo.Done {
            statusLabel = "Done"
            badgeClass = "badge badge-success"
        }
        html += fmt.Sprintf(`<li class="flex items-center justify-between gap-3 rounded-xl bg-base-200/60 px-4 py-3">
            <span class="font-medium">%s</span>
            <span class="%s">%s</span>
        </li>`, todo.Title, badgeClass, statusLabel)
    }
    html += `</ul></div></div>`
{{- else }}
    html := `<div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-4"><header class="space-y-1"><h3 class="text-base font-semibold text-slate-900">Todo list</h3><p class="text-sm text-slate-600">Loaded from the server using HTMX.</p></header><ul class="space-y-2">`
    for _, todo := range todos {
        statusLabel := "Pending"
        badgeClass := "text-amber-600"
        if todo.Done {
            statusLabel = "Done"
            badgeClass = "text-emerald-600"
        }
        html += fmt.Sprintf(`<li class="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700">
            <span>%s</span>
            <span class="font-medium %s">%s</span>
        </li>`, todo.Title, badgeClass, statusLabel)
    }
    html += `</ul></div>`
{{- end }}

    fmt.Fprint(w, html)
}

{{- end }}

{{- if and (.Stack.HasFeature "frontend-htmx") (or (has "Basecoat" .Stack.Tags) (has "DaisyUI" .Stack.Tags)) }}

func (r *Router) toastSuccess(w http.ResponseWriter, req *http.Request) {
    w.Header().Set("Content-Type", "text/html; charset=utf-8")
    {{- if has "Basecoat" .Stack.Tags }}
    fmt.Fprint(w, `<div class="toast" role="status" aria-atomic="true" aria-hidden="false" data-category="success">
    <div class="toast-content">
        <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></svg>
        <section>
            <h2>Success</h2>
            <p>HTMX loaded this toast from the backend.</p>
        </section>
        <footer>
            <button type="button" class="btn" data-toast-action>Dismiss</button>
        </footer>
    </div>
</div>`)
    {{- else if has "DaisyUI" .Stack.Tags }}
    fmt.Fprint(w, `<div class="alert alert-success shadow-lg transition-opacity duration-200">
    <span>HTMX loaded this toast from the backend.</span>
    <button type="button" class="btn btn-sm btn-ghost" data-daisy-toast-dismiss>Dismiss</button>
</div>`)
    {{- end }}
}

{{- end }}
